<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium | El Basurero</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" href="Imagenes/icono.png" type="image/x-icon">
</head>
<body style="display:none;">
  <div id="header"></div>

  <main class="playlist-container">
    <h1>Premium</h1>
    <p>Bienvenido a tu contenido exclusivo.</p>
    
    <!-- Barra de búsqueda -->
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Buscar por título, descripción, temporada o episodio...">
      <button id="clearSearch" style="display: none;">Limpiar</button>
    </div>

    <!-- Grid para las tarjetas de listas de reproducción -->
    <div class="premium-grid" id="playlistList"></div>

    <!-- Contenedor para los videos de una lista seleccionada o resultados de búsqueda (inicialmente oculto) -->
    <div id="videoContainer" style="display: none;"></div>
  </main>

  <div id="footer"></div>

  <script src="js/scripts.js"></script>
  <script type="module">
    import { protectPage } from "./js/roleManager.js";
    import "./js/login.js";
    import { videosPremium } from "./js/videos-premium.js";

    protectPage(["premium", "admin"], "index.html");

    // Cargar header y footer
    fetch('header.html').then(r => r.text()).then(d => {
      document.getElementById('header').innerHTML = d;
      window.initAuthButtons();
    });
    fetch('footer.html').then(r => r.text()).then(d => document.getElementById('footer').innerHTML = d);

    // Agrupar videos por 'name' (serie o categoría)
    const groupedVideos = videosPremium.reduce((acc, video) => {
      const key = video.name || 'Otros';
      if (!acc[key]) {
        acc[key] = [];
      }
      acc[key].push(video);
      return acc;
    }, {});

    // Mapa de thumbnails para las listas de reproducción (portadas personalizadas)
    // Puedes asignar paths a imágenes que subas a GitHub, ej: 'Imagenes/shingeki_cover.jpg'
    // Por defecto, usa el thumbnail del primer video del grupo
    const playlistThumbnails = {
      // 'Shingeki No Kyojin': 'Imagenes/shingeki_cover.jpg',
      // 'Nada': 'Imagenes/nada_cover.jpg',
      // Agrega más aquí según tus listas
    };

    // Función para obtener thumbnail de una lista
    function getPlaylistThumbnail(groupName) {
      return playlistThumbnails[groupName] || groupedVideos[groupName][0]?.thumbnail || 'Imagenes/default_cover.jpg';
    }

    // Función para crear una tarjeta de video
    function createVideoCard(video) {
      const card = document.createElement('div');
      card.className = 'premium-card';

      const formattedTitle = video.title.replace(/\\n/g, '<br>');

      card.innerHTML = `
        <a href="player.html?id=${video.id}">
          <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
          <div class="premium-info">
            <h2>${video.title}</h2>
            <h1>${video.title2}</h1>
            <p class="premium-episode">T${video.temporada} E${video.episodio} • ${video.name}</p>
            <p class="premium-desc">${video.description}</p>
          </div>
        </a>
      `;

      return card;
    }

    // Función para mostrar videos de una lista o resultados de búsqueda
    function showVideos(titleText, videos, isSearch = false) {
      const playlistList = document.getElementById('playlistList');
      const videoContainer = document.getElementById('videoContainer');

      playlistList.style.display = 'none';
      videoContainer.style.display = 'block';
      videoContainer.innerHTML = '';

      // Botón de volver (solo si no es búsqueda, ya que búsqueda tiene 'Limpiar')
      if (!isSearch) {
        const backBtn = document.createElement('button');
        backBtn.textContent = 'Volver a listas';
        backBtn.className = 'back-button';
        backBtn.onclick = () => {
          videoContainer.style.display = 'none';
          playlistList.style.display = 'grid';
          searchInput.value = ''; // Limpiar búsqueda al volver
          clearButton.style.display = 'none';
        };
        videoContainer.appendChild(backBtn);
      }

      // Título de la sección
      const title = document.createElement('h2');
      title.textContent = titleText;
      videoContainer.appendChild(title);

      // Grid de videos
      const grid = document.createElement('div');
      grid.className = 'premium-grid';

      if (videos.length === 0) {
        const noResults = document.createElement('p');
        noResults.textContent = 'No se encontraron resultados.';
        videoContainer.appendChild(noResults);
      } else {
        videos.forEach(video => {
          grid.appendChild(createVideoCard(video));
        });
      }

      videoContainer.appendChild(grid);
    }

    // Renderizar tarjetas de listas de reproducción
    const playlistContainer = document.getElementById('playlistList');
    Object.keys(groupedVideos).forEach(groupName => {
      const thumbnail = getPlaylistThumbnail(groupName);
      const card = document.createElement('div');
      card.className = 'premium-card playlist-card'; // Clase extra para estilos específicos si necesitas

      card.innerHTML = `
        <a href="#" onclick="return false;">
          <img src="${thumbnail}" alt="${groupName}" loading="lazy">
          <div class="premium-info">
            <h2>${groupName}</h2>
            <p>${groupedVideos[groupName].length} videos</p>
          </div>
        </a>
      `;

      card.addEventListener('click', () => {
        showVideos(groupName, groupedVideos[groupName]);
      });

      playlistContainer.appendChild(card);
    });

    // Funcionalidad de búsqueda
    const searchInput = document.getElementById('searchInput');
    const clearButton = document.getElementById('clearSearch');

    function filterVideos() {
      const query = searchInput.value.toLowerCase().trim();
      clearButton.style.display = query ? 'inline-block' : 'none';

      if (query) {
        const filtered = videosPremium.filter(video => {
          const title = video.title.toLowerCase();
          const title2 = video.title2.toLowerCase();
          const episode = `t${video.temporada} e${video.episodio} • ${video.name}`.toLowerCase();
          const desc = video.description.toLowerCase();
          return title.includes(query) || title2.includes(query) || episode.includes(query) || desc.includes(query);
        });
        showVideos('Resultados de búsqueda', filtered, true);
      } else {
        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('playlistList').style.display = 'grid';
      }
    }

    searchInput.addEventListener('input', filterVideos);
    clearButton.addEventListener('click', () => {
      searchInput.value = '';
      filterVideos();
    });

    // Mostrar body cuando todo esté listo
    document.body.style.display = 'block';
  </script>
</body>
</html>