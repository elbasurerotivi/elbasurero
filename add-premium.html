<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cargar Videos Premium - El Basurero</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="Imagenes/icono.png" type="image/x-icon">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px;
      min-height: 100vh;
    }
    .form-container {
      background: #222;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      max-width: 750px;
      width: 100%;
    }
    h1 { text-align: center; margin-bottom: 25px; }
    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: white;
      font-size: 1rem;
    }
    textarea { resize: vertical; min-height: 100px; }
    button {
      margin-top: 25px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #00acee;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #0084b8; }
    .button-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
      justify-content: center;
    }
    .output {
      margin-top: 20px;
      background: #333;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    #preview {
      margin-top: 10px;
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      display: none;
    }
    .small-btn {
      padding: 10px 16px;
      font-size: 1rem;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <h1>Agregar Video Premium</h1>

    <form id="videoForm">
      <label for="categoria">Categor√≠a (clave)</label>
      <select id="categoria" required>
        <option value="">-- Selecciona una categor√≠a --</option>
        <option value="shingeki_no_kyojin">Shingeki No Kyojin</option>
        <option value="nada">Nada</option>
        <option value="peliculas">Pel√≠culas</option>
        <option value="bloqueados_de_youtube">Bloqueados de YouTube</option>
        <option value="el_encargado">El Encargado</option>
        <!-- Agrega m√°s categor√≠as aqu√≠ cuando las crees -->
      </select>

      <label for="name">Nombre (para mostrar en la lista)</label>
      <input type="text" id="name" placeholder="Ej: Mi Obra Maestra" required>

      <label for="temporada">Temporada (0 si es pel√≠cula)</label>
      <input type="number" id="temporada" value="0" required>

      <label for="episodio">Episodio (0 si es pel√≠cula, o rango como "21-25")</label>
      <input type="text" id="episodio" value="0" required>

      <label for="title">T√≠tulo principal (con emoji)</label>
      <input type="text" id="title" placeholder="üé® Mi obra maestra" required>

      <label for="title2">Subt√≠tulo</label>
      <input type="text" id="title2" placeholder="Con Guillermo Francella y Luis Brandoni" required>

      <label for="description">Descripci√≥n completa</label>
      <textarea id="description" required></textarea>

      <label for="source">Fuente (embed Rumble)</label>
      <input type="url" id="source" placeholder="https://rumble.com/embed/xxxxxx/?pub=xxxx" required>

      <label for="thumbnail">Miniatura (URL o carga manual)</label>
      <input type="url" id="thumbnail" placeholder="Se intenta obtener autom√°ticamente..." />
      <input type="file" id="manualThumbnail" accept="image/*" style="margin-top:8px;">

      <img id="preview" alt="Vista previa">

      <label for="type">Tipo de reproducci√≥n</label>
      <select id="type" required>
        <option value="iframe">iframe</option>
        <option value="video">video</option>
      </select>

      <button type="submit">‚ûï Agregar Video</button>
    </form>

    <div class="button-row">
      <button id="downloadVideos" class="small-btn">‚¨áÔ∏è Descargar videos-premium.js</button>
      <button id="downloadCategorias" class="small-btn">‚¨áÔ∏è Descargar categorias-data.js</button>
      <button id="copyVideos" class="small-btn">üìã Copiar videos</button>
      <button id="copyCategorias" class="small-btn">üìã Copiar categor√≠as</button>
      <button id="clearAll" class="small-btn">üóëÔ∏è Limpiar todo</button>
    </div>

    <pre class="output" id="outputVideos"></pre>
    <pre class="output" id="outputCategorias"></pre>
  </div>

  <script>
    const videosList = [];
    const categoriasSet = new Set(); // Para ir recolectando las categor√≠as usadas

    const form = document.getElementById("videoForm");
    const preview = document.getElementById("preview");
    const sourceInput = document.getElementById("source");
    const thumbnailInput = document.getElementById("thumbnail");
    const manualThumbnail = document.getElementById("manualThumbnail");
    const outputVideos = document.getElementById("outputVideos");
    const outputCategorias = document.getElementById("outputCategorias");

    let autoThumbnail = "";
    let manualThumbnailUrl = "";

    // Generar ID autom√°tico a partir del t√≠tulo
    document.getElementById("title").addEventListener("input", () => {
      const title = document.getElementById("title").value.trim().toLowerCase();
      const id = title
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/(^\s+|\s+$)/g, "")
        .replace(/_+/g, "_");
      // No lo ponemos en input porque ya no usamos campo id visible
    });

    // Obtener thumbnail de Rumble
    async function getRumbleThumbnail(url) {
      try {
        const res = await fetch(url);
        const html = await res.text();
        const match = html.match(/<meta property="og:image" content="([^"]+)"/);
        return match ? match[1] : null;
      } catch (e) {
        console.warn("Error obteniendo thumbnail:", e);
        return null;
      }
    }

    sourceInput.addEventListener("change", async () => {
      const url = sourceInput.value.trim();
      if (!url) return;

      const thumb = await getRumbleThumbnail(url);
      if (thumb) {
        autoThumbnail = thumb;
        thumbnailInput.value = thumb;
        preview.src = thumb;
        preview.style.display = "block";
      }
    });

    manualThumbnail.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        manualThumbnailUrl = "Imagenes/" + file.name;
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // Generar ID √∫nico
    function generarId(title, categoria) {
      const base = title
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/(^_|_$)/g, "");
      return base;
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const categoriaKey = document.getElementById("categoria").value;
      if (!categoriaKey) {
        alert("Selecciona una categor√≠a");
        return;
      }

      const thumbnailUrl = autoThumbnail || manualThumbnailUrl || thumbnailInput.value.trim();
      if (!thumbnailUrl) {
        alert("No hay thumbnail (ni autom√°tica ni manual)");
        return;
      }

      const title = document.getElementById("title").value.trim();
      const id = generarId(title, categoriaKey);

      const video = {
        id,
        name: document.getElementById("name").value.trim(),
        categoria: categoriaKey,
        temporada: document.getElementById("temporada").value,
        episodio: document.getElementById("episodio").value,
        title,
        title2: document.getElementById("title2").value.trim(),
        description: document.getElementById("description").value.trim(),
        thumbnail: thumbnailUrl,
        source: document.getElementById("source").value.trim(),
        type: document.getElementById("type").value
      };

      videosList.push(video);
      categoriasSet.add(categoriaKey);

      actualizarOutputs();
      form.reset();
      preview.style.display = "none";
      autoThumbnail = "";
      manualThumbnailUrl = "";
    });

    function actualizarOutputs() {
      // Videos
      const videosCode = videosList.length > 0
        ? "export const videosPremium = [\n" +
          videosList.map(v => "  " + JSON.stringify(v, null, 2).replace(/"([^"]+)":/g, "$1:").replace(/"/g, "'")).join(",\n\n") +
          "\n];"
        : "export const videosPremium = [];";

      outputVideos.textContent = videosCode;
      outputVideos.style.display = "block";

      // Categor√≠as (solo las que ya tienen al menos un video)
      let categoriasCode = "export const categoriasData = {\n";
      categoriasSet.forEach(key => {
        categoriasCode += `  ${key}: {\n    key: '${key}',\n    name: '${key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase())}',\n    background: 'Imagenes/TU_FONDO_AQUI.jpg',\n    cover: 'Imagenes/TU_COVER_AQUI.jpg',\n    title: '',\n    synopsis: '',\n    year: '',\n    genre: '',\n    cast: ''\n  },\n`;
      });
      categoriasCode += "};";
      outputCategorias.textContent = categoriasCode;
      outputCategorias.style.display = categoriasSet.size > 0 ? "block" : "none";
    }

    // Descargar videos-premium.js
    document.getElementById("downloadVideos").addEventListener("click", () => {
      if (videosList.length === 0) return alert("No hay videos");
      descargarArchivo(outputVideos.textContent, "videos-premium.js");
    });

    // Descargar categorias-data.js
    document.getElementById("downloadCategorias").addEventListener("click", () => {
      if (categoriasSet.size === 0) return alert("No hay categor√≠as a√∫n");
      descargarArchivo(outputCategorias.textContent, "categorias-data.js");
    });

    // Copiar
    document.getElementById("copyVideos").addEventListener("click", () => {
      navigator.clipboard.writeText(outputVideos.textContent);
      alert("Videos copiados al portapapeles");
    });
    document.getElementById("copyCategorias").addEventListener("click", () => {
      navigator.clipboard.writeText(outputCategorias.textContent);
      alert("Categor√≠as copiadas al portapapeles");
    });

    // Limpiar todo
    document.getElementById("clearAll").addEventListener("click", () => {
      if (confirm("¬øBorrar todos los videos y categor√≠as generadas?")) {
        videosList.length = 0;
        categoriasSet.clear();
        outputVideos.style.display = outputCategorias.style.display = "none";
        outputVideos.textContent = outputCategorias.textContent = "";
      }
    });

    // Funci√≥n auxiliar para descargar
    function descargarArchivo(contenido, nombre) {
      const blob = new Blob([contenido], { type: "application/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombre;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>