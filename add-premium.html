<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cargar Videos Premium - El Basurero</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="Imagenes/icono.png" type="image/x-icon">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px;
      min-height: 100vh;
    }
    .form-container {
      background: #222;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      max-width: 750px;
      width: 100%;
    }
    h1 { text-align: center; margin-bottom: 25px; }
    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: white;
      font-size: 1rem;
    }
    textarea { resize: vertical; min-height: 100px; }
    button {
      margin-top: 25px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: #00acee;
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #0084b8; }
    .button-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
      justify-content: center;
    }
    .output {
      margin-top: 20px;
      background: #333;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }
    #preview {
      margin-top: 10px;
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      display: none;
    }
    .small-btn {
      padding: 10px 16px;
      font-size: 1rem;
    }
    .new-cat {
      font-size: 0.9rem;
      color: #0f0;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <h1>Agregar Video Premium</h1>

    <form id="videoForm">
      <!-- Categoría con opción de crear nueva -->
      <label for="categoria">Categoría</label>
      <select id="categoriaSelect">
        <option value="">-- Seleccionar categoría existente --</option>
        <!-- Las opciones se llenan con JS -->
      </select>
      <input type="text" id="nuevaCategoria" placeholder="O escribir clave nueva (ej: stranger_things)" style="margin-top:8px;">
      <div class="new-cat" id="catInfo"></div>

      <label for="name">Nombre (para mostrar)</label>
      <input type="text" id="name" placeholder="Ej: Stranger Things" required>

      <label for="temporada">Temporada (0 si es película)</label>
      <input type="number" id="temporada" value="0" required>

      <label for="episodio">Episodio (0 o rango como "1-8")</label>
      <input type="text" id="episodio" value="0" required>

      <label for="title">Título principal (con emoji)</label>
      <input type="text" id="title" placeholder="Stranger Things T4" required>

      <label for="title2">Subtítulo</label>
      <input type="text" id="title2" placeholder="Volumen 1" required>

      <label for="description">Descripción completa</label>
      <textarea id="description" required></textarea>

      <label for="source">Fuente (embed Rumble)</label>
      <input type="url" id="source" placeholder="https://rumble.com/embed/xxxxxx/?pub=xxxx" required>

      <label for="thumbnail">Miniatura</label>
      <input type="url" id="thumbnail" placeholder="Se intenta obtener automáticamente..." />
      <input type="file" id="manualThumbnail" accept="image/*" style="margin-top:8px;">

      <img id="preview" alt="Vista previa">

      <label for="type">Tipo de reproducción</label>
      <select id="type" required>
        <option value="iframe">iframe</option>
        <option value="video">video</option>
      </select>

      <button type="submit">Agregar Video</button>
    </form>

    <div class="button-row">
      <button id="downloadVideos" class="small-btn">Descargar videos-premium.js</button>
      <button id="downloadCategorias" class="small-btn">Descargar categorias-data.js</button>
      <button id="copyVideos" class="small-btn">Copiar videos</button>
      <button id="copyCategorias" class="small-btn">Copiar categorías</button>
      <button id="clearAll" class="small-btn">Limpiar todo</button>
    </div>

    <pre class="output" id="outputVideos"></pre>
    <pre class="output" id="outputCategorias"></pre>
  </div>

  <script>
    // ==================== VARIABLES GLOBALES ====================
    const videosList = [];
    const categoriasSet = new Set(); // Guarda todas las categorías usadas en esta sesión

    // Categorías iniciales (las que ya tenés)
    const categoriasIniciales = [
      "shingeki_no_kyojin",
      "nada",
      "peliculas",
      "bloqueados_de_youtube",
      "el_encargado"
    ];

    // Añadimos las iniciales al Set y al select
    categoriasIniciales.forEach(cat => categoriasSet.add(cat));

    const select = document.getElementById("categoriaSelect");
    const inputNueva = document.getElementById("nuevaCategoria");
    const catInfo = document.getElementById("catInfo");
    const form = document.getElementById("videoForm");
    const preview = document.getElementById("preview");
    const sourceInput = document.getElementById("source");
    const thumbnailInput = document.getElementById("thumbnail");
    const manualThumbnail = document.getElementById("manualThumbnail");

    let autoThumbnail = "";
    let manualThumbnailUrl = "";

    // ==================== CARGAR SELECT CON CATEGORÍAS ====================
    function actualizarSelect() {
      // Limpiamos excepto la primera opción
      select.innerHTML = '<option value="">-- Seleccionar categoría existente --</option>';
      
      // Ordenamos alfabéticamente
      const ordenadas = [...categoriasSet].sort();
      ordenadas.forEach(key => {
        const nombreBonito = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        const option = document.createElement("option");
        option.value = key;
        option.textContent = nombreBonito;
        select.appendChild(option);
      });
    }

    // Cargar al inicio
    actualizarSelect();

    // ==================== DETECTAR NUEVA CATEGORÍA ====================
    inputNueva.addEventListener("input", () => {
      const valor = inputNueva.value.trim().toLowerCase()
        .replace(/[^a-z0-9_]+/g, "_")
        .replace(/_+/g, "_")
        .replace(/^_|_$/g, "");

      if (valor && !categoriasSet.has(valor)) {
        catInfo.textContent = `Nueva categoría: "${valor}" (se creará automáticamente)`;
        catInfo.style.color = "#0f0";
      } else if (categoriasSet.has(valor)) {
        catInfo.textContent = `Ya existe: "${valor}"`;
        catInfo.style.color = "#ff0";
      } else {
        catInfo.textContent = "";
      }

      // Actualizamos el select para que aparezca la nueva (solo si ya la confirmamos)
    });

    // ==================== OBTENER CATEGORÍA FINAL ====================
    function obtenerCategoria() {
      let cat = select.value;
      if (!cat) {
        const nueva = inputNueva.value.trim().toLowerCase()
          .replace(/[^a-z0-9_]+/g, "_")
          .replace(/_+/g, "_")
          .replace(/^_|_$/g, "");
        if (nueva) {
          cat = nueva;
          categoriasSet.add(cat);
          actualizarSelect();
          select.value = cat; // La seleccionamos automáticamente
          inputNueva.value = "";
          catInfo.textContent = `Categoría "${cat}" creada y seleccionada`;
          setTimeout(() => catInfo.textContent = "", 3000);
        }
      }
      return cat;
    }

    // ==================== THUMBNAIL AUTOMÁTICO RUMBLE ====================
    async function getRumbleThumbnail(url) {
      try {
        const res = await fetch(url);
        const html = await res.text();
        const match = html.match(/<meta property="og:image" content="([^"]+)"/);
        return match ? match[1] : null;
      } catch (e) {
        console.warn(e);
        return null;
      }
    }

    sourceInput.addEventListener("change", async () => {
      const url = sourceInput.value.trim();
      if (!url) return;
      const thumb = await getRumbleThumbnail(url);
      if (thumb) {
        autoThumbnail = thumb;
        thumbnailInput.value = thumb;
        preview.src = thumb;
        preview.style.display = "block";
      }
    });

    manualThumbnail.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        manualThumbnailUrl = "Imagenes/" + file.name;
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // ==================== GENERAR ID ====================
    function generarId(title) {
      return title.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "_")
        .replace(/^_|_$/g, "");
    }

    // ==================== ENVÍO DEL FORMULARIO ====================
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const categoriaKey = obtenerCategoria();
      if (!categoriaKey) {
        alert("Por favor seleccioná o escribí una categoría");
        return;
      }

      const thumbnailUrl = autoThumbnail || manualThumbnailUrl || thumbnailInput.value.trim();
      if (!thumbnailUrl) {
        alert("Falta la miniatura");
        return;
      }

      const title = document.getElementById("title").value.trim();
      const id = generarId(title + "_" + categoriaKey); // Para mayor unicidad

      const video = {
        id,
        name: document.getElementById("name").value.trim(),
        categoria: categoriaKey,
        temporada: document.getElementById("temporada").value,
        episodio: document.getElementById("episodio").value,
        title,
        title2: document.getElementById("title2").value.trim(),
        description: document.getElementById("description").value.trim(),
        thumbnail: thumbnailUrl,
        source: document.getElementById("source").value.trim(),
        type: document.getElementById("type").value
      };

      videosList.push(video);
      actualizarOutputs();

      // Reset
      form.reset();
      preview.style.display = "none";
      autoThumbnail = "";
      manualThumbnailUrl = "";
      inputNueva.value = "";
      catInfo.textContent = "";
    });

    // ==================== ACTUALIZAR SALIDAS ====================
    function actualizarOutputs() {
      // Videos
      const videosCode = videosList.length > 0
        ? "export const videosPremium = [\n" +
          videosList.map(v => "  " + JSON.stringify(v, null, 2)
            .replace(/"([^"]+)":/g, "$1:")
            .replace(/"/g, "'")
          ).join(",\n\n") +
          "\n];"
        : "export const videosPremium = [];";

      document.getElementById("outputVideos").textContent = videosCode;
      document.getElementById("outputVideos").style.display = "block";

      // Categorías (solo las usadas)
      let catCode = "export const categoriasData = {\n";
      [...categoriasSet].sort().forEach(key => {
        const nombreBonito = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        catCode += `  ${key}: {\n`;
        catCode += `    key: '${key}',\n`;
        catCode += `    name: '${nombreBonito}',\n`;
        catCode += `    background: 'Imagenes/FONDO_${key.toUpperCase()}.jpg',     // Cambiar\n`;
        catCode += `    cover: 'Imagenes/COVER_${key.toUpperCase()}.jpg',         // Cambiar\n`;
        catCode += `    title: '${nombreBonito}',\n`;
        catCode += `    synopsis: '',\n`;
        catCode += `    year: '',\n`;
        catCode += `    genre: '',\n`;
        catCode += `    cast: ''\n`;
        catCode += `  },\n`;
      });
      catCode += "};";

      document.getElementById("outputCategorias").textContent = catCode;
      document.getElementById("outputCategorias").style.display = categoriasSet.size > 0 ? "block" : "none";
    }

    // ==================== BOTONES DESCARGA / COPIAR ====================
    function descargar(contenido, nombre) {
      const blob = new Blob([contenido], { type: "application/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombre;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("downloadVideos").addEventListener("click", () => {
      if (!videosList.length) return alert("No hay videos");
      descargar(document.getElementById("outputVideos").textContent, "videos-premium.js");
    });

    document.getElementById("downloadCategorias").addEventListener("click", () => {
      if (!categoriasSet.size) return alert("No hay categorías");
      descargar(document.getElementById("outputCategorias").textContent, "categorias-data.js");
    });

    document.getElementById("copyVideos").addEventListener("click", () => {
      navigator.clipboard.writeText(document.getElementById("outputVideos").textContent);
      alert("Videos copiados");
    });

    document.getElementById("copyCategorias").addEventListener("click", () => {
      navigator.clipboard.writeText(document.getElementById("outputCategorias").textContent);
      alert("Categorías copiadas");
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      if (confirm("¿Borrar todo?")) {
        videosList.length = 0;
        categoriasSet.clear();
        categoriasIniciales.forEach(c => categoriasSet.add(c));
        actualizarSelect();
        document.querySelectorAll(".output").forEach(el => el.style.display = "none");
      }
    });
  </script>
</body>
</html>