<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproductor | El Basurero</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" href="Imagenes/icono.png" type="image/x-icon">
  <style>
    .video-interactions {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      font-family: 'Roboto', sans-serif;
    }

    .like-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f2f2f2;
      border: none;
      padding: 10px 16px;
      border-radius: 24px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .like-btn:hover { background: #e0e0e0; }
    .like-btn.liked {
      background: #065fd4;
      color: white;
    }

    .comments-section {
      margin-top: 32px;
      font-family: 'Roboto', sans-serif;
    }

    #commentsCount {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .comment-form {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: flex-start;
    }

    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-input-wrapper {
      flex: 1;
    }

    #commentText {
      width: 100%;
      border: none;
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
      font-size: 14px;
      resize: none;
      outline: none;
    }

    #commentText:focus {
      border-bottom: 2px solid #065fd4;
    }

    .comment-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .comment-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      font-weight: 500;
    }

    #cancelComment { background: transparent; color: #606060; }
    #sendComment {
      background: #f2f2f2;
      color: #606060;
    }
    #sendComment:enabled {
      background: #065fd4;
      color: white;
    }

    .comment {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .comment img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .comment-content {
      flex: 1;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .comment-author { font-weight: 500; }
    .comment-time { color: #606060; }

    .comment-text { font-size: 14px; margin-bottom: 8px; word-wrap: break-word; }

    .comment-footer {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 13px;
    }

    .comment-like {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      color: #606060;
    }

    .comment-like.liked { color: #065fd4; }

    .reply-btn {
      background: none;
      border: none;
      color: #065fd4;
      font-size: 13px;
      cursor: pointer;
    }

    .replies {
      margin-left: 52px;
      margin-top: 12px;
    }

    .reply-form {
      display: flex;
      gap: 12px;
      margin: 12px 0 0 52px;
    }

    .reply-form textarea {
      flex: 1;
      border: none;
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
      font-size: 13px;
      resize: none;
    }

    .admin-delete {
      background: none;
      border: none;
      color: #c00;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
    }
  </style>
</head>
<body style="display:none;">
  <div id="header"></div>

  <main class="player-container">
    <h1 id="videoTitle"></h1>
    <div class="video-wrapper" id="videoContainer"></div>
    <p id="videoDescription"></p>

    <div class="video-interactions">
      <div class="like-section">
        <button id="likeBtn" class="like-btn">
          <span class="like-icon">Like</span>
          <span id="likeCount">0</span>
        </button>
      </div>
    </div>

    <section class="comments-section" id="commentsSection">
      <h3 id="commentsCount">0 Comentarios</h3>

      <div id="commentForm" style="display:none;">
        <div class="comment-form">
          <img id="userAvatar" src="" alt="Tú" class="comment-avatar">
          <div class="comment-input-wrapper">
            <textarea id="commentText" placeholder="Agrega un comentario público..." maxlength="1000"></textarea>
            <div class="comment-actions">
              <button id="cancelComment">Cancelar</button>
              <button id="sendComment" disabled>Comentar</button>
            </div>
          </div>
        </div>
      </div>

      <div id="commentsList"></div>
    </section>

    <div class="back-btn">
      <a href="playlist.html">← Volver a Premium</a>
    </div>
  </main>

  <div id="footer"></div>

  <script src="js/scripts.js"></script>
  <script type="module">
    import { protectPage } from "./js/roleManager.js";
    import "./js/login.js";
    import { videosPremium } from "./js/videos-premium.js";
    import { auth, db, ref, push, onValue, set, update, remove, get, onAuthStateChanged, increment } from "./js/firebase-config.js";

    protectPage(["premium", "admin"], "index.html");

    fetch('header.html').then(r => r.text()).then(d => {
      document.getElementById('header').innerHTML = d;
      window.initAuthButtons();
    });
    fetch('footer.html').then(r => r.text()).then(d => document.getElementById('footer').innerHTML = d);

    const params = new URLSearchParams(window.location.search);
    const videoId = params.get('id');
    const video = videosPremium.find(v => v.id === videoId);

    const titleEl = document.getElementById('videoTitle');
    const descEl = document.getElementById('videoDescription');
    const container = document.getElementById('videoContainer');

    if (video) {
      titleEl.textContent = video.title;
      descEl.textContent = video.description;

      if (video.type === 'iframe') {
        container.innerHTML = `
          <iframe src="${video.source}" width="100%" height="500" frameborder="0" allowfullscreen allow="fullscreen; autoplay; encrypted-media"></iframe>
        `;
      } else if (video.type === 'video') {
        container.innerHTML = `
          <video controls width="100%" preload="metadata">
            <source src="${video.source}" type="video/mp4">
            Tu navegador no soporta video.
          </video>
        `;
      }
    } else {
      titleEl.textContent = 'Video no encontrado';
      descEl.textContent = 'El video solicitado no existe o no está disponible.';
      container.innerHTML = '<p style="text-align:center;color:#ccc;">Error 404</p>';
    }

    let currentUser = null;
    let isAdmin = false;
    let videoRef = null;
    let commentsUnsub = null;

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        document.getElementById('userAvatar').src = user.photoURL || 'Imagenes/default-avatar.png';
        document.getElementById('commentForm').style.display = 'block';
        const roleSnap = await get(ref(db, `users/${user.uid}/role`));
        isAdmin = roleSnap.val() === 'admin';
      } else {
        document.getElementById('commentForm').style.display = 'none';
        isAdmin = false;
      }
      loadVideoInteractions();
    });

    function loadVideoInteractions() {
      if (!videoId) return;

      videoRef = ref(db, `videos/${videoId}`);

      const likeBtn = document.getElementById('likeBtn');
      const likeCountEl = document.getElementById('likeCount');
      const likesCountRef = ref(db, `videos/${videoId}/likesCount`);
      const userLikeRef = ref(db, `videos/${videoId}/likedBy/${currentUser?.uid}`);

      onValue(likesCountRef, (snap) => {
        likeCountEl.textContent = snap.val() || 0;
      });

      if (currentUser) {
        onValue(userLikeRef, (snap) => {
          likeBtn.classList.toggle('liked', !!snap.val());
        });
      }

      likeBtn.addEventListener('click', async () => {
        if (!currentUser) return alert('Inicia sesión para dar like');
        const snap = await get(userLikeRef);
        if (snap.val()) {
          await update(videoRef, {
            likesCount: increment(-1),
            [`likedBy/${currentUser.uid}`]: null
          });
        } else {
          await update(videoRef, {
            likesCount: increment(1),
            [`likedBy/${currentUser.uid}`]: true
          });
        }
      });

      const commentsRef = ref(db, `videos/${videoId}/comments`);
      commentsUnsub = onValue(commentsRef, (snap) => {
        renderComments(snap.val() || {});
        const count = Object.keys(snap.val() || {}).length;
        document.getElementById('commentsCount').textContent = `${count} Comentario${count !== 1 ? 's' : ''}`;
      });
    }

    document.getElementById('sendComment').addEventListener('click', async () => {
      const text = document.getElementById('commentText').value.trim();
      if (!text || !currentUser) return;

      const commentsRef = ref(db, `videos/${videoId}/comments`);
      await push(commentsRef, {
        userId: currentUser.uid,
        userName: currentUser.displayName || 'Anónimo',
        userPhoto: currentUser.photoURL || 'Imagenes/default-avatar.png',
        text,
        timestamp: Date.now(),
        likesCount: 0
      });

      document.getElementById('commentText').value = '';
      document.getElementById('sendComment').disabled = true;
    });

    document.getElementById('commentText').addEventListener('input', (e) => {
      document.getElementById('sendComment').disabled = !e.target.value.trim();
    });

    document.getElementById('cancelComment').addEventListener('click', () => {
      document.getElementById('commentText').value = '';
      document.getElementById('sendComment').disabled = true;
    });

    function renderComments(comments) {
      const list = document.getElementById('commentsList');
      list.innerHTML = '';

      Object.entries(comments).forEach(([id, c]) => {
        const el = document.createElement('div');
        el.className = 'comment';
        el.innerHTML = `
          <img src="${c.userPhoto || 'Imagenes/default-avatar.png'}" alt="${c.userName}">
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author">${c.userName}</span>
              <span class="comment-time">${timeAgo(c.timestamp)}</span>
              ${isAdmin ? '<button class="admin-delete" data-type="comment" data-id="' + id + '">Eliminar</button>' : ''}
            </div>
            <div class="comment-text">${escapeHtml(c.text)}</div>
            <div class="comment-footer">
              <button class="comment-like ${c.likedBy?.[currentUser?.uid] ? 'liked' : ''}" data-id="${id}" data-type="comment">
                Like <span>${c.likesCount || 0}</span>
              </button>
              <button class="reply-btn" data-id="${id}">Responder</button>
            </div>
            <div class="replies" id="replies-${id}"></div>
          </div>
        `;
        list.appendChild(el);

        if (c.replies) renderReplies(id, c.replies);

        el.querySelector('.reply-btn').onclick = () => showReplyForm(id);
        el.querySelector('.comment-like')?.onclick = () => toggleLike('comment', id);
        el.querySelector('.admin-delete')?.onclick = () => deleteItem('comment', id);
      });
    }

    function renderReplies(commentId, replies) {
      const container = document.getElementById(`replies-${commentId}`);
      container.innerHTML = '';
      Object.entries(replies).forEach(([id, r]) => {
        const el = document.createElement('div');
        el.className = 'comment';
        el.innerHTML = `
          <img src="${r.userPhoto || 'Imagenes/default-avatar.png'}" alt="${r.userName}">
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author">${r.userName}</span>
              <span class="comment-time">${timeAgo(r.timestamp)}</span>
              ${isAdmin ? '<button class="admin-delete" data-type="reply" data-cid="' + commentId + '" data-id="' + id + '">Eliminar</button>' : ''}
            </div>
            <div class="comment-text">${escapeHtml(r.text)}</div>
            <div class="comment-footer">
              <button class="comment-like ${r.likedBy?.[currentUser?.uid] ? 'liked' : ''}" data-cid="${commentId}" data-id="${id}" data-type="reply">
                Like <span>${r.likesCount || 0}</span>
              </button>
            </div>
          </div>
        `;
        container.appendChild(el);
        el.querySelector('.comment-like')?.onclick = () => toggleLike('reply', id, commentId);
        el.querySelector('.admin-delete')?.onclick = () => deleteItem('reply', id, commentId);
      });
    }

    function showReplyForm(commentId) {
      if (!currentUser) return alert('Inicia sesión para responder');
      if (document.getElementById(`reply-form-${commentId}`)) return;

      const form = document.createElement('div');
      form.id = `reply-form-${commentId}`;
      form.className = 'reply-form';
      form.innerHTML = `
        <img src="${currentUser.photoURL || 'Imagenes/default-avatar.png'}" alt="Tú" class="comment-avatar">
        <textarea placeholder="Escribe tu respuesta..." maxlength="500"></textarea>
        <div class="comment-actions">
          <button onclick="this.closest('.reply-form').remove()">Cancelar</button>
          <button id="send-reply-${commentId}" disabled>Responder</button>
        </div>
      `;

      document.getElementById(`replies-${commentId}`).before(form);
      const textarea = form.querySelector('textarea');
      const btn = form.querySelector(`#send-reply-${commentId}`);

      textarea.oninput = () => btn.disabled = !textarea.value.trim();
      btn.onclick = async () => {
        const text = textarea.value.trim();
        if (!text) return;
        const replyRef = ref(db, `videos/${videoId}/comments/${commentId}/replies`);
        await push(replyRef, {
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Anónimo',
          userPhoto: currentUser.photoURL || 'Imagenes/default-avatar.png',
          text,
          timestamp: Date.now(),
          likesCount: 0
        });
        form.remove();
      };
    }

    async function toggleLike(type, id, commentId = null) {
      if (!currentUser) return alert('Inicia sesión');
      const path = type === 'comment' 
        ? `videos/${videoId}/comments/${id}`
        : `videos/${videoId}/comments/${commentId}/replies/${id}`;
      const likeRef = ref(db, `${path}/likedBy/${currentUser.uid}`);
      const snap = await get(likeRef);
      if (snap.val()) {
        await update(ref(db, path), {
          likesCount: increment(-1),
          [`likedBy/${currentUser.uid}`]: null
        });
      } else {
        await update(ref(db, path), {
          likesCount: increment(1),
          [`likedBy/${currentUser.uid}`]: true
        });
      }
    }

    async function deleteItem(type, id, commentId = null) {
      if (!isAdmin) return;
      if (!confirm(`¿Eliminar este ${type === 'comment' ? 'comentario' : 'respuesta'}?`)) return;
      const path = type === 'comment'
        ? `videos/${videoId}/comments/${id}`
        : `videos/${videoId}/comments/${commentId}/replies/${id}`;
      await remove(ref(db, path));
    }

    function timeAgo(ts) {
      const diff = Date.now() - ts;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (days > 0) return `hace ${days} día${days > 1 ? 's' : ''}`;
      if (hours > 0) return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
      if (minutes > 0) return `hace ${minutes} min`;
      return 'ahora';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.body.style.display = 'block';
  </script>
</body>
</html>